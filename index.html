<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ruta Maps - Nombres Limpios</title>
  <style>
    :root { --primary: #1a73e8; --bg: #f8f9fa; --card: #ffffff; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: var(--bg); color: #202124; }
    .card { background: var(--card); padding: 2rem; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
    h1 { margin-top: 0; font-size: 1.6rem; }
    
    .field-group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #3c4043; font-size: 0.9rem; }
    input { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
    input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(26,115,232,0.2); }
    
    .details { margin-top: 8px; font-size: 0.9rem; min-height: 24px; display: flex; align-items: center; }
    .place-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 6px; font-weight: 500; font-size: 0.9rem; }
    .tag-blue { color: #1a73e8; background: #e8f0fe; }
    .tag-gray { color: #5f6368; background: #f1f3f4; }
    .loading { color: #666; font-style: italic; font-size: 0.85rem; }
    
    .controls { display: flex; gap: 12px; margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1.5rem; }
    button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .btn-add { background: white; color: var(--primary); border: 1px solid #dadce0; }
    .btn-gen { background: var(--primary); color: white; flex-grow: 1; }

    #output { margin-top: 2rem; display: none; background: #e8f0fe; padding: 1.5rem; border-radius: 8px; }
    .result-link { display: block; word-break: break-all; margin: 10px 0; padding: 12px; background: white; border-radius: 4px; color: var(--primary); text-decoration: none; border: 1px solid #d2e3fc; }
  </style>
</head>
<body>

<div class="card">
  <h1>üìç Generador de Rutas</h1>
  <p style="color:#666; margin-bottom:2rem;">
    Detecta nombres de lugares, hoteles y empresas autom√°ticamente.
  </p>

  <div id="inputs-list"></div>

  <div class="controls">
    <button class="btn-add" onclick="addStop()">+ A√±adir Parada</button>
    <button class="btn-gen" onclick="generate()">Generar Ruta</button>
  </div>

  <div id="output">
    <strong>üîó Enlace generado:</strong>
    <a id="final-link" class="result-link" href="#" target="_blank"></a>
  </div>
</div>

<script>
let timeout = null;

document.addEventListener('DOMContentLoaded', () => { for(let i=0; i<4; i++) addStop(); });

function addStop() {
    const list = document.getElementById('inputs-list');
    const idx = list.children.length;
    const div = document.createElement('div');
    div.className = 'field-group';
    let txt = idx===0 ? "Origen" : (idx===3 && list.children.length===3 ? "Destino" : "Parada "+idx);
    
    div.innerHTML = `
        <label>${txt}</label>
        <input type="text" placeholder="URL o Direcci√≥n" oninput="handleInput(this)">
        <div class="details"></div>
    `;
    list.appendChild(div);
}

function handleInput(input) {
    const details = input.nextElementSibling;
    details.innerHTML = '';
    clearTimeout(timeout);
    
    const val = input.value.trim();
    if(!val) {
        input.removeAttribute('data-val');
        return;
    }

    // 1. URLs (Extracci√≥n r√°pida)
    if (val.includes('http') || val.includes('google.com')) {
        let extracted = null;
        let displayName = "Enlace";
        
        // Prioridad: Nombre en URL (/place/NOMBRE/)
        if (val.includes('/place/')) {
            const m = val.match(/\/place\/([^\/]+)/);
            if (m && m[1]) {
                // Decodificar y quitar +
                let cleanName = decodeURIComponent(m[1]).replace(/\+/g, ' ');
                // Truco: Si el nombre contiene comas (ej: Calle, 12), cortamos para dejar lo principal
                if (cleanName.includes(',') && cleanName.length > 25) {
                    cleanName = cleanName.split(',')[0];
                }
                
                extracted = cleanName; // Usamos el nombre para buscar ruta
                // Guardamos el nombre limpio para mostrar
                displayName = "üè¢ " + cleanName;
                input.dataset.val = cleanName; 
                renderTag(details, displayName, 'blue');
                return;
            }
        }

        // Si es coords ocultas (!3d...!4d)
        const pin = val.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
        if (pin) {
            const coords = `${pin[1]},${pin[2]}`;
            // Aqu√≠ hacemos la magia: LLAMAR A API PARA SACAR NOMBRE REAL DE ESAS COORDS
            // (Antes solo mostr√°bamos coords, ahora buscamos qu√© es)
            details.innerHTML = '<span class="loading">üîç Identificando lugar...</span>';
            resolveNameFromCoords(pin[1], pin[2], details, input);
            return;
        }
        
        // Fallback
        input.dataset.val = val;
        renderTag(details, "üîó Enlace Web", 'gray');
        return;
    }

    // 2. Texto manual -> API
    details.innerHTML = '<span class="loading">üîç Buscando...</span>';
    timeout = setTimeout(() => {
        smartSearch(val, details, input);
    }, 700);
}

// --- B√öSQUEDA INTELIGENTE DE NOMBRE CORTO ---
async function resolveNameFromCoords(lat, lon, container, input) {
    const data = await fetchReverse(lat, lon);
    if (data) {
        const name = extractShortName(data);
        input.dataset.val = `${lat},${lon}`; // Para la ruta seguimos usando coords (es m√°s preciso)
        renderTag(container, "üè¢ " + name, 'blue');
    } else {
        input.dataset.val = `${lat},${lon}`;
        renderTag(container, `üìç ${lat}, ${lon}`, 'gray');
    }
}

async function smartSearch(query, container, input) {
    let found = await fetchSearch(query);
    
    // Cascada simple
    if (!found && query.includes(',')) {
        found = await fetchSearch(query.split(',').slice(0,2).join(','));
    }

    if (found) {
        const shortName = extractShortName(found);
        renderTag(container, "üè¢ " + shortName, 'blue');
        input.dataset.val = `${found.lat},${found.lon}`;
    } else {
        renderTag(container, "‚ö†Ô∏è Texto original", 'gray');
        input.dataset.val = query;
    }
}

// L√ìGICA CLAVE: Extraer solo el nombre importante del JSON de Nominatim
function extractShortName(place) {
    // 1. ¬øTiene nombre propio expl√≠cito? (address.amenity, shop, tourism, leisure)
    const addr = place.address || {};
    
    // Lista de campos que suelen ser "Nombres de sitios" y no calles
    const nameFields = ['amenity', 'shop', 'tourism', 'leisure', 'office', 'building', 'historic', 'aeroway'];
    
    for (let field of nameFields) {
        if (addr[field]) return addr[field]; // Ej: "Hotel DC" (amenity)
    }

    // 2. Si no es un POI, ¬øes una calle/direcci√≥n?
    if (addr.road || addr.pedestrian) {
        let road = addr.road || addr.pedestrian;
        if (addr.house_number) return `${road}, ${addr.house_number}`;
        return road;
    }

    // 3. Fallback: El primer trozo del display_name
    return place.display_name.split(',')[0];
}

async function fetchSearch(q) {
    try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=1`);
        return (await r.json())[0];
    } catch(e) { return null; }
}

async function fetchReverse(lat, lon) {
    try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);
        return await r.json();
    } catch(e) { return null; }
}

function renderTag(container, text, color) {
    container.innerHTML = `<div class="place-tag tag-${color}">${text}</div>`;
}

function generate() {
    const inputs = document.querySelectorAll('input');
    const points = [];
    inputs.forEach(inp => {
        let val = inp.dataset.val || inp.value.trim();
        if(val) points.push(encodeURIComponent(val));
    });

    if(points.length < 2) { alert("Faltan puntos"); return; }

    const url = `https://www.google.com/maps/dir/?api=1&origin=${points[0]}&destination=${points[points.length-1]}` + 
                (points.length > 2 ? `&waypoints=${points.slice(1,-1).join('%7C')}` : '');

    const a = document.getElementById('final-link');
    document.getElementById('output').style.display = 'block';
    a.href = url;
    a.textContent = url;
}
</script>

</body>
</html>
